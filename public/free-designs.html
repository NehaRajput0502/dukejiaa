<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Get Free Embroidery Designs | DUKEJIA</title>
  <meta name="description" content="Verify your mobile number to unlock free embroidery designs from DUKEJIA."/>
  <link rel="canonical" href="https://dukejiaa.vercel.app/free-designs.html"/>
  <meta name="robots" content="index,follow"/>

  <!-- GA4 (site analytics + funnel events) -->
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JV4T04TFTJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JV4T04TFTJ');
</script>

  <!-- Fonts to match your site -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{--pur:#045285;--pur2:#833ade;--lgray:#E8EDF2;--ink:#2D3436}
    body{font-family:Inter,system-ui; margin:0; background:#faf9f6; color:var(--ink)}
    .wrap{max-width:980px; margin:0 auto; padding:24px}
    h1{font-weight:900; color:var(--pur); margin:8px 0 6px}
    .muted{color:#6b7280}
    .card{background:#fff; border:1px solid var(--lgray); border-radius:16px; padding:18px; box-shadow:0 10px 28px rgba(0,0,0,.06); margin:14px 0}
    .grid{display:grid; gap:14px}
    .cols-2{grid-template-columns:1fr}
    .cols-3{grid-template-columns:1fr}
    @media(min-width:740px){ .cols-2{grid-template-columns:1fr 1fr} .cols-3{grid-template-columns:repeat(3,1fr)} }
    label{font-weight:700; display:block; margin:2px 0 6px}
    input{width:100%; padding:12px; border:1px solid var(--lgray); border-radius:12px; font:600 14px Inter}
    button{padding:12px 16px; border-radius:12px; font-weight:800; border:0; cursor:pointer}
    .btn{background:linear-gradient(90deg,var(--pur),var(--pur2)); color:#fff}
    .btn.ghost{background:#fff; border:1px solid var(--lgray); color:var(--pur)}
    .hidden{display:none}
    .gallery a{display:block}
    .gallery img{width:100%; height:240px; object-fit:cover; border-radius:12px; border:1px solid var(--lgray)}
    .pill{display:inline-block; padding:6px 10px; border:1px solid var(--lgray); border-radius:999px; font-weight:700; margin-right:8px}
    .msg{font-weight:700}
    .err{color:#b91c1c}
    .ok{color:#065f46}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
      <a href="/"><img src="/images/dukejia.png" alt="DUKEJIA" width="150" height="44" loading="eager"></a>
      <span class="muted">Free resource</span>
    </header>

    <h1>Get Free Embroidery Designs</h1>
    <p class="muted">Verify your mobile number to unlock the design gallery. We’ll also send machine suggestions based on your use-case.</p>

    <!-- Step A: Lead form -->
    <section id="step-info" class="card grid cols-2">
      <div>
        <label for="lead-name">Name</label>
        <input id="lead-name" placeholder="Your Name" required>
      </div>
      <div>
        <label for="lead-phone">Mobile (India)</label>
        <input id="lead-phone" placeholder="+91 98xxxxxxx" inputmode="tel" required>
      </div>
      <div>
        <label for="lead-city">City (optional)</label>
        <input id="lead-city" placeholder="City">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btn-send-otp" class="btn">Send OTP</button>
        <button id="btn-cancel" class="btn ghost" type="button" onclick="location.href='/'">Cancel</button>
      </div>
      <div class="muted" id="info-msg" role="status"></div>
      <div id="recaptcha-container"></div>
    </section>

    <!-- Step B: OTP -->
    <section id="step-otp" class="card hidden">
      <div class="grid cols-2">
        <div>
          <label for="otp-code">Enter OTP</label>
          <input id="otp-code" placeholder="6-digit code" inputmode="numeric">
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button id="btn-verify-otp" class="btn">Verify & Unlock</button>
          <button id="btn-resend" class="btn ghost" type="button">Resend</button>
        </div>
      </div>
      <div id="otp-msg" class="msg" role="status"></div>
    </section>

    <!-- Step C: Gallery -->
    <section id="step-gallery" class="hidden">
      <div class="card" style="margin:16px 0">
        <span class="pill">Verified</span>
        <strong id="hello"></strong>
        <span class="muted">— designs unlocked</span>
      </div>
      <div class="gallery grid cols-3" id="design-grid"></div>
      <div class="card" style="margin-top:16px">
        <p class="muted" style="margin:0">Liked a design? <a href="/Contact.html">Request a demo</a> or WhatsApp us:
          <a href="https://wa.me/919350513789" target="_blank" rel="noopener">+91 93505 13789</a>.
        </p>
      </div>
    </section>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>

  <script>
    /* =========================
       1) FIREBASE CONFIG (edit)
       ========================= */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    /* =========================
       2) HELPERS & UTM CAPTURE
       ========================= */
    const $ = id => document.getElementById(id);
    const stepInfo = $("step-info"), stepOtp = $("step-otp"), stepGallery = $("step-gallery");
    const btnSendOtp = $("btn-send-otp"), btnVerify = $("btn-verify-otp"), btnResend = $("btn-resend");
    const infoMsg = $("info-msg"), otpMsg = $("otp-msg"), hello = $("hello");
    let confirmationResult = null, phoneE164 = "";

    const params = new URLSearchParams(location.search);
    const UTM = {
      source: params.get('utm_source') || '',
      medium: params.get('utm_medium') || '',
      campaign: params.get('utm_campaign') || ''
    };

    function normalizePhone(raw){
      let p = (raw||'').replace(/[^\d+]/g,'');
      if (!p.startsWith('+')) p = '+91' + p;
      return p;
    }
    function toggle(disabled){
      btnSendOtp.disabled = disabled; btnVerify.disabled = disabled; btnResend.disabled = disabled;
    }

    /* =========================
       3) Invisible reCAPTCHA
       ========================= */
    let recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });

    /* =========================
       4) SEND OTP (with GA events)
       ========================= */
    btnSendOtp.onclick = async () => {
      const name = $("lead-name").value.trim();
      const rawPhone = $("lead-phone").value.trim();
      const city = $("lead-city").value.trim();
      if (!name || !rawPhone) { infoMsg.textContent = "Enter name & mobile."; return; }

      phoneE164 = normalizePhone(rawPhone);
      infoMsg.textContent = "Sending OTP…"; toggle(true);
      // GA event: attempt
      window.gtag && gtag('event','otp_send_attempt',{page:'free-designs', method:'phone', country:'IN'});

      try {
        confirmationResult = await auth.signInWithPhoneNumber(phoneE164, recaptchaVerifier);
        infoMsg.textContent = "OTP sent. Check your SMS.";
        stepInfo.classList.add("hidden");
        stepOtp.classList.remove("hidden");
        sessionStorage.setItem("leadName", name);
        sessionStorage.setItem("leadPhone", phoneE164);
        sessionStorage.setItem("leadCity", city);
        // GA event: sent
        window.gtag && gtag('event','otp_sent',{page:'free-designs', method:'phone'});
      } catch (e) {
        console.error(e);
        infoMsg.textContent = "Failed to send OTP. Try again.";
        // GA event: fail
        window.gtag && gtag('event','otp_send_failed',{page:'free-designs', reason:String(e&&e.code||'error')});
        recaptchaVerifier.clear();
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      } finally {
        toggle(false);
      }
    };

    /* =========================
       5) VERIFY OTP (with GA events)
       ========================= */
    btnVerify.onclick = async () => {
      const code = $("otp-code").value.trim();
      if (!code) { otpMsg.textContent = "Enter the OTP."; return; }
      otpMsg.className = "msg"; otpMsg.textContent = "Verifying…"; toggle(true);
      window.gtag && gtag('event','otp_verify_attempt',{page:'free-designs'});

      try {
        const cred = await confirmationResult.confirm(code);
        // verified
        otpMsg.className = "msg ok"; otpMsg.textContent = "Verified!";
        stepOtp.classList.add("hidden"); stepGallery.classList.remove("hidden");
        hello.textContent = "Hi " + (sessionStorage.getItem("leadName") || "there");

        // Lead payload (includes UTM & page info)
        const payload = {
          ts: Date.now(),
          name: sessionStorage.getItem("leadName"),
          phone: sessionStorage.getItem("leadPhone"),
          city: sessionStorage.getItem("leadCity"),
          product: "Free-Designs",
          source: "free-designs",
          page: location.href,
          utm: UTM,
          ua: navigator.userAgent
        };

        // Fire serverless → n8n/Sheet
        fetch("/api/lead", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        }).catch(()=>{});

        // Load gallery
        loadDesigns();

        // GA funnel event
        window.gtag && gtag('event','free_designs_unlocked',{
          method:'phone_otp',
          city: payload.city || '',
          utm_source: UTM.source, utm_medium: UTM.medium, utm_campaign: UTM.campaign
        });
      } catch (e) {
        console.error(e);
        otpMsg.className = "msg err"; otpMsg.textContent = "Invalid OTP. Try again.";
        window.gtag && gtag('event','otp_verify_failed',{page:'free-designs', reason:String(e&&e.code||'error')});
      } finally {
        toggle(false);
      }
    };

    btnResend.onclick = () => {
      stepOtp.classList.add("hidden");
      stepInfo.classList.remove("hidden");
      infoMsg.textContent = "You can try resending the OTP.";
    };

    /* =========================
       6) LOAD DESIGNS
       ========================= */
    async function loadDesigns(){
      try {
        const res = await fetch("/data/designs.json", { cache: "no-store" });
        const items = await res.json();
        const grid = document.getElementById("design-grid");
        grid.innerHTML = "";
        items.forEach(d => {
          const a = document.createElement("a");
          a.href = d.download || d.image; a.target = "_blank"; a.rel = "noopener";
          a.innerHTML = `
            <img src="${d.image}" loading="lazy" alt="${d.title || 'Design'}">
            <div class="muted" style="margin-top:8px">${d.title || ''}</div>
          `;
          grid.appendChild(a);
        });
        // GA: gallery loaded
        window.gtag && gtag('event','design_gallery_loaded',{count: items.length});
      } catch {
        document.getElementById("design-grid").innerHTML = "<p class='muted'>Designs will appear here.</p>";
      }
    }
  </script>
</body>
</html>
